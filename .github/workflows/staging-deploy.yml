name: ğŸ§ª Deploy to Staging

on:
  push:
    branches: [main]

jobs:
  deploy-staging:
    name: ğŸš€ Deploy to Staging Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # ===========================
      # Backend ãƒ‡ãƒ—ãƒ­ã‚¤
      # ===========================
      - name: ğŸ“¦ Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: ğŸ—ï¸ Build backend
        working-directory: ./backend
        run: npm run build
      
      - name: ğŸš€ Deploy backend to Staging
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          source: "backend/dist/*,backend/package*.json"
          target: "/tmp/backend-deploy/"
          strip_components: 1
      
      - name: ğŸ“‚ Update backend on Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          script: |
            cd ~/projects/dump-tracker/backend
            rm -rf dist
            cp -r /tmp/backend-deploy/dist .
            cp /tmp/backend-deploy/package*.json .
            npm ci --production
            rm -rf /tmp/backend-deploy
            sudo systemctl restart dump-tracker-backend.service
            echo "âœ… Backend deployed to Staging"

      # ===========================
      # Mobile Frontend ãƒ‡ãƒ—ãƒ­ã‚¤
      # ===========================
      - name: ğŸ“¦ Install mobile dependencies
        working-directory: ./frontend/mobile
        run: npm ci
      
      - name: ğŸ—ï¸ Build mobile app
        working-directory: ./frontend/mobile
        run: |
          mkdir -p .cert
          touch .cert/localhost-key.pem
          touch .cert/localhost-cert.pem
          sed -i 's/useRef<number | null>/useRef<any>/g' src/pages/OperationMain.tsx || true
          npm run build
      
      - name: ğŸš€ Deploy mobile to Staging
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          source: "frontend/mobile/dist/*"
          target: "/tmp/mobile-deploy/"
          strip_components: 3
      
      - name: ğŸ“‚ Update mobile on Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          script: |
            rm -rf ~/projects/dump-tracker/frontend/mobile/dist/*
            cp -r /tmp/mobile-deploy/* ~/projects/dump-tracker/frontend/mobile/dist/
            chmod -R 755 ~/projects/dump-tracker/frontend/mobile/dist
            rm -rf /tmp/mobile-deploy
            echo "âœ… Mobile deployed to Staging"

      # ===========================
      # CMS Frontend ãƒ‡ãƒ—ãƒ­ã‚¤
      # ===========================
      - name: ğŸ“¦ Install CMS dependencies
        working-directory: ./frontend/cms
        run: npm ci
      
      - name: ğŸ—ï¸ Build CMS
        working-directory: ./frontend/cms
        run: npm run build
      
      - name: ğŸš€ Deploy CMS to Staging
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          source: "frontend/cms/dist/*"
          target: "/tmp/cms-deploy/"
          strip_components: 3
      
      - name: ğŸ“‚ Update CMS on Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          script: |
            rm -rf ~/projects/dump-tracker/frontend/cms/dist/*
            cp -r /tmp/cms-deploy/* ~/projects/dump-tracker/frontend/cms/dist/
            chmod -R 755 ~/projects/dump-tracker/frontend/cms/dist
            rm -rf /tmp/cms-deploy
            sudo systemctl reload nginx
            echo "âœ… CMS deployed to Staging"
      
      - name: âœ… Deployment Complete
        run: |
          echo "ğŸ‰ Staging deployment completed successfully!"
          echo "ğŸ“± Mobile: https://dumptracker-s.ddns.net/"
          echo "ğŸ’¼ CMS: https://dumptracker-s.ddns.net:3003/"
          echo "ğŸ“š API Docs: https://dumptracker-s.ddns.net/docs/"