name: ðŸ§ª Deploy to Staging

on:
  push:
    branches: [main]

jobs:
  deploy-staging:
    name: ðŸš€ Deploy to Staging Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # ===========================
      # Backend ãƒ‡ãƒ—ãƒ­ã‚¤
      # ===========================
      - name: ðŸ“¦ Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: ðŸ—ï¸ Build backend
        working-directory: ./backend
        run: npm run build
      
      - name: ðŸš€ Deploy backend to Staging
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          source: "backend/dist/*,backend/package*.json"
          target: "/tmp/backend-deploy/"
          strip_components: 1
      
      - name: ðŸ“‚ Update backend on Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          script: |
            cd ~/projects/dump-tracker/backend
            rm -rf dist
            cp -r /tmp/backend-deploy/dist .
            cp /tmp/backend-deploy/package*.json .
            export PATH=$HOME/.nvm/versions/node/v20.19.6/bin:$PATH
            npm ci --production
            pkill -f "node.*dist/index.js"
            nohup node dist/index.js > /dev/null 2>&1 &
            echo "âœ… Backend deployed to Staging"

      # ===========================
      # Mobile Frontend ãƒ‡ãƒ—ãƒ­ã‚¤
      # ===========================
      - name: ðŸ“¦ Install mobile dependencies
        working-directory: ./frontend/mobile
        run: npm ci
      
      - name: ðŸ”§ Create Staging .env.production for Mobile
        working-directory: ./frontend/mobile
        run: |
          cat > .env.production << EOF
          VITE_API_BASE_URL=${{ secrets.STAGING_API_URL }}
          VITE_GOOGLE_MAPS_API_KEY=AIzaSyCpQGN2eC7q0jE-wZdVO_NauO5_NgmVerk
          VITE_APP_ENV=staging
          EOF
      
      - name: ðŸ—ï¸ Build mobile app
        working-directory: ./frontend/mobile
        run: |
          mkdir -p .cert
          touch .cert/localhost-key.pem
          touch .cert/localhost-cert.pem
          sed -i 's/useRef<number | null>/useRef<any>/g' src/pages/OperationMain.tsx || true
          npm run build
      
      - name: ðŸš€ Deploy mobile to Staging
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          source: "frontend/mobile/dist/*"
          target: "/tmp/mobile-deploy/"
          strip_components: 3
      
      - name: ðŸ“‚ Update mobile on Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          script: |
            rm -rf ~/projects/dump-tracker/frontend/mobile/dist/*
            cp -r /tmp/mobile-deploy/* ~/projects/dump-tracker/frontend/mobile/dist/
            chmod -R 755 ~/projects/dump-tracker/frontend/mobile/dist
            rm -rf /tmp/mobile-deploy
            echo "âœ… Mobile deployed to Staging"

      # ===========================
      # CMS Frontend ãƒ‡ãƒ—ãƒ­ã‚¤
      # ===========================
      - name: ðŸ“¦ Install CMS dependencies
        working-directory: ./frontend/cms
        run: npm ci
      
      - name: ðŸ”§ Create Staging .env.production for CMS
        working-directory: ./frontend/cms
        run: |
          cat > .env.production << EOF
          VITE_API_BASE_URL=${{ secrets.STAGING_API_URL }}
          VITE_GOOGLE_MAPS_API_KEY=AIzaSyCpQGN2eC7q0jE-wZdVO_NauO5_NgmVerk
          VITE_APP_ENV=staging
          VITE_GPS_UPDATE_INTERVAL=5000
          VITE_DEBUG=false
          VITE_LOG_LEVEL=error
          EOF
      
      - name: ðŸ—ï¸ Build CMS
        working-directory: ./frontend/cms
        run: npm run build
      
      - name: ðŸš€ Deploy CMS to Staging
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          source: "frontend/cms/dist/*"
          target: "/tmp/cms-deploy/"
          strip_components: 3
      
      - name: ðŸ“‚ Update CMS on Staging
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_PRIVATE_KEY }}
          script: |
            rm -rf ~/projects/dump-tracker/frontend/cms/dist/*
            cp -r /tmp/cms-deploy/* ~/projects/dump-tracker/frontend/cms/dist/
            chmod -R 755 ~/projects/dump-tracker/frontend/cms/dist
            rm -rf /tmp/cms-deploy
            sudo systemctl reload nginx
            echo "âœ… CMS deployed to Staging"
      
      - name: âœ… Deployment Complete
        run: |
          echo "ðŸŽ‰ Staging deployment completed successfully!"
          echo "ðŸ“± Mobile: https://dumptracker-s.ddns.net/"
          echo "ðŸ’¼ CMS: https://dumptracker-s.ddns.net:3003/"
          echo "ðŸ“š API Docs: https://dumptracker-s.ddns.net/docs/"