name: ğŸš€ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # =====================================
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
  # =====================================
  deploy-backend:
    name: ğŸ–¥ï¸ Deploy Backend API
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: ğŸ—ï¸ Build backend (TypeScript compilation)
        working-directory: ./backend
        run: npm run build
      
      - name: ğŸš€ Deploy backend files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "backend/dist/*,backend/package*.json,backend/prisma/*"
          target: "/tmp/backend-deploy/"
          strip_components: 1
      
      - name: ğŸ“‚ Update backend and restart service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼ˆå¿µã®ãŸã‚ï¼‰
            BACKUP_DIR="/home/karkyon_dump/projects/dump-tracker/backend.backup.$(date +%Y%m%d_%H%M%S)"
            cp -r /home/karkyon_dump/projects/dump-tracker/backend/dist "$BACKUP_DIR" || true
            
            # æ–°ã—ã„ãƒ“ãƒ«ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
            rm -rf /home/karkyon_dump/projects/dump-tracker/backend/dist
            cp -r /tmp/backend-deploy/dist /home/karkyon_dump/projects/dump-tracker/backend/
            
            # package.jsonã‚’æ›´æ–°ï¼ˆä¾å­˜é–¢ä¿‚ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆï¼‰
            cp /tmp/backend-deploy/package*.json /home/karkyon_dump/projects/dump-tracker/backend/
            
            # Prismaã‚¹ã‚­ãƒ¼ãƒæ›´æ–°
            cp -r /tmp/backend-deploy/prisma /home/karkyon_dump/projects/dump-tracker/backend/
            
            # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
            cd /home/karkyon_dump/projects/dump-tracker/backend
            npm ci --production
            
            # Prisma Clientå†ç”Ÿæˆ
            npx prisma generate
            
            # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤ï¼‰
            # npx prisma migrate deploy
            
            # systemdã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
            sudo systemctl restart dump-tracker-backend.service
            
            # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
            sudo systemctl is-active dump-tracker-backend.service
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
            rm -rf /tmp/backend-deploy
            
            # ãƒ­ã‚°ç¢ºèªï¼ˆæœ€æ–°10è¡Œï¼‰
            echo "=== Backend Service Status ==="
            sudo systemctl status dump-tracker-backend.service --no-pager -l || true
            echo "=== Recent Logs ==="
            tail -n 10 /home/karkyon_dump/projects/dump-tracker/backend/logs/app.log || true

  # =====================================
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆMobileï¼‰ãƒ‡ãƒ—ãƒ­ã‚¤
  # =====================================
  deploy-mobile:
    name: ğŸ“± Deploy Mobile App
    runs-on: ubuntu-latest
    needs: deploy-backend  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Œäº†å¾Œã«å®Ÿè¡Œ
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend/mobile
        run: npm ci
      
      - name: ğŸ—ï¸ Build mobile app
        working-directory: ./frontend/mobile
        run: |
          mkdir -p .cert
          touch .cert/localhost-key.pem
          touch .cert/localhost-cert.pem
          sed -i 's/useRef<number | null>/useRef<any>/g' src/pages/OperationMain.tsx || true
          npm run build
      
      - name: ğŸš€ Deploy to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "frontend/mobile/dist/*"
          target: "/tmp/mobile-deploy/"
          strip_components: 3
      
      - name: ğŸ“‚ Move to web root
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo rm -rf /var/www/dump-tracker/mobile/*
            sudo cp -r /tmp/mobile-deploy/* /var/www/dump-tracker/mobile/
            sudo chown -R www-data:www-data /var/www/dump-tracker/mobile
            sudo chmod -R 755 /var/www/dump-tracker/mobile
            rm -rf /tmp/mobile-deploy
            sudo systemctl reload nginx
            echo "=== Mobile Deploy Complete ==="
            ls -la /var/www/dump-tracker/mobile/ || true

  # =====================================
  # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœé€šçŸ¥
  # =====================================
  notify:
    name: ğŸ“¢ Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-mobile]
    if: always()
    
    steps:
      - name: ğŸ“Š Show deployment results
        run: |
          echo "================================"
          echo "ğŸ‰ Deployment Completed"
          echo "================================"
          echo "Backend: ${{ needs.deploy-backend.result }}"
          echo "Mobile: ${{ needs.deploy-mobile.result }}"
          echo "================================"
          if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.deploy-mobile.result }}" == "success" ]; then
            echo "âœ… All deployments successful!"
            exit 0
          else
            echo "âŒ Some deployments failed"
            exit 1
          fi