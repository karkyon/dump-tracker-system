name: ðŸš€ Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true

jobs:
  deploy-production:
    name: ðŸ­ Deploy to Production Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: âš ï¸ Verify deployment confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DEPLOY" ]; then
            echo "âŒ Deployment cancelled: confirmation word not matched"
            exit 1
          fi
          echo "âœ… Deployment confirmed"
      
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # ===========================
      # Backend ãƒ‡ãƒ—ãƒ­ã‚¤
      # ===========================
      - name: ðŸ“¦ Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: ðŸ—ï¸ Build backend
        working-directory: ./backend
        run: npm run build
      
      - name: ðŸš€ Deploy backend to Production
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          source: "backend/dist/*,backend/package*.json"
          target: "/tmp/backend-deploy/"
          strip_components: 1
      
      - name: ðŸ“‚ Update backend on Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          script: |
            cd ~/projects/dump-tracker/backend
            rm -rf dist
            cp -r /tmp/backend-deploy/dist .
            cp /tmp/backend-deploy/package*.json .
            npm ci --production
            rm -rf /tmp/backend-deploy
            sudo systemctl restart dump-tracker-backend.service
            echo "âœ… Backend deployed to Production"

      # ===========================
      # Mobile Frontend ãƒ‡ãƒ—ãƒ­ã‚¤
      # ===========================
      - name: ðŸ“¦ Install mobile dependencies
        working-directory: ./frontend/mobile
        run: npm ci
      
      - name: ðŸ”§ Create Production .env.production for Mobile
        working-directory: ./frontend/mobile
        run: |
          cat > .env.production << EOF
          VITE_API_BASE_URL=${{ secrets.PRODUCTION_API_URL }}
          VITE_GOOGLE_MAPS_API_KEY=AIzaSyC1LrD7xMN_sLZ5iELaLpPzXPeQeEoH6pY
          VITE_APP_ENV=production
          EOF
      
      - name: ðŸ—ï¸ Build mobile app
        working-directory: ./frontend/mobile
        run: |
          mkdir -p .cert
          touch .cert/localhost-key.pem
          touch .cert/localhost-cert.pem
          sed -i 's/useRef<number | null>/useRef<any>/g' src/pages/OperationMain.tsx || true
          npm run build
      
      - name: ðŸš€ Deploy mobile to Production
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          source: "frontend/mobile/dist/*"
          target: "/tmp/mobile-deploy/"
          strip_components: 3
      
      - name: ðŸ“‚ Update mobile on Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          script: |
            rm -rf ~/projects/dump-tracker/frontend/mobile/dist/*
            cp -r /tmp/mobile-deploy/* ~/projects/dump-tracker/frontend/mobile/dist/
            chmod -R 755 ~/projects/dump-tracker/frontend/mobile/dist
            rm -rf /tmp/mobile-deploy
            echo "âœ… Mobile deployed to Production"

      # ===========================
      # CMS Frontend ãƒ‡ãƒ—ãƒ­ã‚¤
      # ===========================
      - name: ðŸ“¦ Install CMS dependencies
        working-directory: ./frontend/cms
        run: npm ci
      
      - name: ðŸ”§ Create Production .env.production for CMS
        working-directory: ./frontend/cms
        run: |
          cat > .env.production << EOF
          VITE_API_BASE_URL=${{ secrets.PRODUCTION_API_URL }}
          VITE_GOOGLE_MAPS_API_KEY=AIzaSyC1LrD7xMN_sLZ5iELaLpPzXPeQeEoH6pY
          VITE_APP_ENV=production
          VITE_GPS_UPDATE_INTERVAL=5000
          VITE_DEBUG=false
          VITE_LOG_LEVEL=error
          EOF
      
      - name: ðŸ—ï¸ Build CMS
        working-directory: ./frontend/cms
        run: npm run build
      
      - name: ðŸš€ Deploy CMS to Production
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          source: "frontend/cms/dist/*"
          target: "/tmp/cms-deploy/"
          strip_components: 3
      
      - name: ðŸ“‚ Update CMS on Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}
          script: |
            rm -rf ~/projects/dump-tracker/frontend/cms/dist/*
            cp -r /tmp/cms-deploy/* ~/projects/dump-tracker/frontend/cms/dist/
            chmod -R 755 ~/projects/dump-tracker/frontend/cms/dist
            rm -rf /tmp/cms-deploy
            sudo systemctl reload nginx
            echo "âœ… CMS deployed to Production"
      
      - name: âœ… Deployment Complete
        run: |
          echo "ðŸŽ‰ Production deployment completed successfully!"
          echo "ðŸ“± Mobile: https://dump-tracker.ddns.net/"
          echo "ðŸ’¼ CMS: https://dump-tracker.ddns.net:3003/"
          echo "ðŸ“š API Docs: https://dump-tracker.ddns.net/docs/"