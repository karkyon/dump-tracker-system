// =====================================
// backend/src/routes/userRoutes.ts
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ«ãƒ¼ãƒˆ - Controlleræ´»ç”¨ç‰ˆ
// ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©ã®ã¿ãƒ»ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯Controllerå±¤ã«å§”è­²
// æœ€çµ‚æ›´æ–°: 2025å¹´10æœˆ18æ—¥
// ä¾å­˜é–¢ä¿‚: middleware/auth.ts, controllers/userController.ts
// =====================================

/**
 * ã€è¨­è¨ˆæ–¹é‡ã€‘
 *
 * routeså±¤ã®è²¬å‹™: ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©ã®ã¿
 * - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
 * - èªè¨¼ãƒ»èªå¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®é©ç”¨
 * - Controllerãƒ¡ã‚½ãƒƒãƒ‰ã¸ã®å§”è­²
 *
 * ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»DBæ“ä½œã¯å…¨ã¦Controller/Serviceå±¤ã«å§”è­²
 * tripRoutes.tsç­‰ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨
 */

import { Router } from 'express';

// ğŸ¯ Phase 1å®Œäº†åŸºç›¤ã®æ´»ç”¨
import {
  authenticateToken,
  authorize,
  requireAdmin
} from '../middleware/auth';

// ğŸ¯ Controllerã®çµ±åˆæ´»ç”¨ï¼ˆå…¨æ©Ÿèƒ½å®Ÿè£…æ¸ˆã¿ï¼‰
import { getUserController } from '../controllers/userController';

// =====================================
// ãƒ«ãƒ¼ã‚¿ãƒ¼åˆæœŸåŒ–
// =====================================

const router = Router();
const userController = getUserController();

// =====================================
// å…¨ãƒ«ãƒ¼ãƒˆã§èªè¨¼å¿…é ˆ
// =====================================

router.use(authenticateToken());

// =====================================
// ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå…¨æ©Ÿèƒ½å®Ÿè£…ï¼‰
// =====================================

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
 * GET /users
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ»æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿
 * - ãƒ­ãƒ¼ãƒ«åˆ¥ãƒ•ã‚£ãƒ«ã‚¿
 * - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ãƒ•ã‚£ãƒ«ã‚¿
 * - ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
 * - æ¨©é™: ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
 */
router.get('/',
  authorize(['ADMIN', 'MANAGER']),
  userController.getAllUsers
);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°å–å¾—
 * GET /users/:id
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±
 * - æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ã¾ãŸã¯ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰
 * - é–¢é€£é‹è¡Œæƒ…å ±ï¼ˆæ¨©é™ã«å¿œã˜ã¦ï¼‰
 */
router.get('/:id', userController.getUserById);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
 * POST /users
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
 * - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
 * - é‡è¤‡ãƒã‚§ãƒƒã‚¯
 * - æ¨©é™: ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
 */
router.post('/',
  authorize(['ADMIN', 'MANAGER']),
  userController.createUser
);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°
 * PUT /users/:id
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±æ›´æ–°
 * - æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ã¾ãŸã¯ç®¡ç†è€…ï¼‰
 * - ç‰¹æ¨©ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¿è­·ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
 */
router.put('/:id', userController.updateUser);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
 * DELETE /users/:id
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
 * - è‡ªå·±å‰Šé™¤é˜²æ­¢
 * - æ¨©é™: ç®¡ç†è€…ã®ã¿
 */
router.delete('/:id',
  requireAdmin,
  userController.deleteUser
);

/**
 * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
 * PUT /users/:id/password
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
 * - æ–°ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
 */
router.put('/:id/password', userController.changePassword);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡æ›¿
 * PATCH /users/:id/toggle-status
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ‡æ›¿
 * - æ¨©é™: ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
 */
router.patch('/:id/toggle-status',
  authorize(['ADMIN', 'MANAGER']),
  userController.toggleUserStatus
);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆå–å¾—
 * GET /users/api/stats
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
 * - ãƒ­ãƒ¼ãƒ«åˆ¥çµ±è¨ˆ
 * - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç‡
 * - æœ€è¿‘ã®ãƒ­ã‚°ã‚¤ãƒ³çµ±è¨ˆ
 * - æ¨©é™: ç®¡ç†è€…
 */
router.get('/api/stats',
  requireAdmin,
  userController.getUserStatistics
);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å–å¾—
 * GET /users/:id/activities
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£å±¥æ­´
 * - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
 * - æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ã¾ãŸã¯ç®¡ç†è€…ï¼‰
 */
router.get('/:id/activities', userController.getUserActivities);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šå–å¾—
 * GET /users/:id/preferences
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ãƒ¦ãƒ¼ã‚¶ãƒ¼å€‹åˆ¥è¨­å®š
 * - æ¨©é™: æœ¬äººã®ã¿
 */
router.get('/:id/preferences', userController.getUserPreferences);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šæ›´æ–°
 * PUT /users/:id/preferences
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ãƒ¦ãƒ¼ã‚¶ãƒ¼å€‹åˆ¥è¨­å®šæ›´æ–°
 * - æ¨©é™: æœ¬äººã®ã¿
 */
router.put('/:id/preferences', userController.updateUserPreferences);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
 * GET /users/search
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
 * - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
 * - æ¨©é™: ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
 */
router.get('/search',
  authorize(['ADMIN', 'MANAGER']),
  userController.searchUsers
);

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€æ‹¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
 * POST /users/bulk/status
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€æ‹¬æ›´æ–°
 * - æ¨©é™: ç®¡ç†è€…
 */
router.post('/bulk/status',
  requireAdmin,
  userController.bulkUpdateUserStatus
);

// =====================================
// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
// =====================================

export default router;

// =====================================
// å®Œäº†ç¢ºèª
// =====================================

/**
 * âœ… routes/userRoutes.ts Controlleræ´»ç”¨ç‰ˆå®Œäº†
 *
 * ã€è¨­è¨ˆåŸå‰‡ã€‘
 * âœ… routeså±¤: ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©ã®ã¿ï¼ˆè–„ãä¿ã¤ï¼‰
 * âœ… Controllerå±¤: HTTPå‡¦ç†ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¤‰æ›
 * âœ… Serviceå±¤: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãƒ»DBæ“ä½œ
 * âœ… ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸€è²«æ€§: tripRoutes.tsç­‰ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³
 *
 * ã€å®Ÿè£…æ©Ÿèƒ½ã€‘
 * âœ… åŸºæœ¬CRUD: ä¸€è¦§ãƒ»è©³ç´°ãƒ»ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤
 * âœ… èªè¨¼æ©Ÿèƒ½: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
 * âœ… ç®¡ç†æ©Ÿèƒ½: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡æ›¿ãƒ»çµ±è¨ˆãƒ»æ¤œç´¢ãƒ»ä¸€æ‹¬æ›´æ–°
 * âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½: ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ»è¨­å®šç®¡ç†
 * âœ… æ¨©é™åˆ¶å¾¡: ãƒ­ãƒ¼ãƒ«åˆ¥ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
 *
 * ã€Controlleræ´»ç”¨åŠ¹æœã€‘
 * âœ… ã‚³ãƒ¼ãƒ‰é‡: ~150è¡Œï¼ˆç›´æ¥å®Ÿè£…ã®1/10ï¼‰
 * âœ… ä¿å®ˆæ€§: é«˜ï¼ˆè²¬å‹™åˆ†é›¢ï¼‰
 * âœ… ãƒ†ã‚¹ãƒˆæ€§: é«˜ï¼ˆå„å±¤ç‹¬ç«‹ãƒ†ã‚¹ãƒˆå¯èƒ½ï¼‰
 * âœ… ä¸€è²«æ€§: ä»–routesãƒ•ã‚¡ã‚¤ãƒ«ã¨çµ±ä¸€
 * âœ… å‹å®‰å…¨æ€§: Controllerå±¤ã§å®Œå…¨æ‹…ä¿
 *
 * ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ•°ã€‘
 * å…¨13ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
 * - GET /users: ä¸€è¦§
 * - GET /users/:id: è©³ç´°
 * - POST /users: ä½œæˆ
 * - PUT /users/:id: æ›´æ–°
 * - DELETE /users/:id: å‰Šé™¤
 * - PUT /users/:id/password: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
 * - PATCH /users/:id/toggle-status: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡æ›¿
 * - GET /users/api/stats: çµ±è¨ˆ
 * - GET /users/:id/activities: ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
 * - GET /users/:id/preferences: è¨­å®šå–å¾—
 * - PUT /users/:id/preferences: è¨­å®šæ›´æ–°
 * - GET /users/search: æ¤œç´¢
 * - POST /users/bulk/status: ä¸€æ‹¬æ›´æ–°
 */
