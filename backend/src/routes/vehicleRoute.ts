// =====================================
// backend/src/routes/vehicleRoute.ts
// è»Šä¸¡ç®¡ç†ãƒ«ãƒ¼ãƒˆ - ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼å®Œå…¨è§£æ¶ˆç‰ˆ
// tripRoutes.tsãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ãƒ»å…¨37ä»¶ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ
// æœ€çµ‚æ›´æ–°: 2025å¹´10æœˆ18æ—¥
// ä¾å­˜é–¢ä¿‚: controllers/vehicleController.ts, middleware/auth.ts, middleware/validation.ts
// çµ±åˆåŸºç›¤: middlewareå±¤100%ãƒ»controllerså±¤çµ±åˆãƒ»serviceså±¤å®ŒæˆåŸºç›¤é€£æº
// =====================================

/**
 * ã€é‡è¦ãªè¨­è¨ˆæ±ºå®šã®ç†ç”±ã€‘
 *
 * å…ƒã®vehicleRoutes.tsã¯å¤šæ•°ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’å«ã‚“ã§ã„ã¾ã—ãŸãŒã€
 * ã“ã‚Œã¯ä»¥ä¸‹ã®ç†ç”±ã§ç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸ:
 *
 * 1. validationãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå•é¡Œ
 *    - validateRequest, validateVehicleCreateDataç­‰ãŒåå‰ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„
 *    - middleware/validation.tsã®å®Ÿè£…ã¨ä¸æ•´åˆ
 *
 * 2. VehicleServiceã®ãƒ¡ã‚½ãƒƒãƒ‰ä¸åœ¨
 *    - getMaintenanceHistory, getOperationHistoryç­‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒæœªå®Ÿè£…
 *    - routeså±¤ã§ç›´æ¥å‘¼ã³å‡ºãã†ã¨ã—ã¦ã„ãŸãŒå­˜åœ¨ã—ãªã„
 *
 * 3. å‹å®šç¾©ã®ä¸ä¸€è‡´
 *    - AuthenticatedUser.id vs AuthenticatedUser.userId
 *    - asyncHandlerã®æˆ»ã‚Šå€¤å‹ã®ä¸ä¸€è‡´
 *
 * ã—ãŸãŒã£ã¦ã€æœ¬ä¿®æ­£ã§ã¯:
 * - tripRoutes.tsã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œå…¨é©ç”¨
 * - controllerå±¤ã¸ã®å®Œå…¨å§”è­²ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯controller/serviceã§å‡¦ç†ï¼‰
 * - routeså±¤ã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ã¿ã«å¾¹ã™ã‚‹
 * - å­˜åœ¨ã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ã¿ä½¿ç”¨
 */

import { Router } from 'express';

// ğŸ¯ Phase 1å®Œäº†åŸºç›¤ã®æ´»ç”¨ï¼ˆtripRoutes.tsãƒ‘ã‚¿ãƒ¼ãƒ³æº–æ‹ ï¼‰
import {
  authenticateToken,
  requireAdmin,
  requireManagerOrAdmin
} from '../middleware/auth';
import {
  validateId,
  validatePaginationQuery
} from '../middleware/validation';
import logger from '../utils/logger';

// ğŸ¯ å®Œæˆæ¸ˆã¿controllerså±¤ã¨ã®å¯†é€£æº
import {
  assignVehicleToDriver,
  createVehicle,
  deleteVehicle,
  getAllVehicles,
  getVehicleById,
  getVehicleStatistics,
  searchVehicles,
  updateVehicle,
  updateVehicleStatus
} from '../controllers/vehicleController';

// ğŸ¯ types/ã‹ã‚‰ã®çµ±ä¸€å‹å®šç¾©ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

// =====================================
// ãƒ«ãƒ¼ã‚¿ãƒ¼åˆæœŸåŒ–
// =====================================

const router = Router();

// =====================================
// å…¨ãƒ«ãƒ¼ãƒˆã§èªè¨¼å¿…é ˆ
// =====================================

router.use(authenticateToken);

// =====================================
// ğŸš— è»Šä¸¡ç®¡ç†APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå…¨æ©Ÿèƒ½å®Ÿè£…ï¼‰
// =====================================

/**
 * è»Šä¸¡ä¸€è¦§å–å¾—
 * GET /vehicles
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ»æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿
 * - è¤‡æ•°æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€è»Šç¨®ã€ç‡ƒæ–™ã‚¿ã‚¤ãƒ—ã€å¹´å¼ç¯„å›²ï¼‰
 * - çµ±è¨ˆæƒ…å ±å–å¾—ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * - ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆç™»éŒ²ç•ªå·ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€å‹å¼ã€å¹´å¼ï¼‰
 * - æ¨©é™ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿åˆ¶å¾¡
 */
router.get('/', validatePaginationQuery, getAllVehicles);

/**
 * è»Šä¸¡è©³ç´°å–å¾—
 * GET /vehicles/:id
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - è»Šä¸¡åŸºæœ¬æƒ…å ±
 * - æœ€æ–°GPSä½ç½®æƒ…å ±
 * - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å±¥æ­´æ¦‚è¦
 * - é‹è¡Œçµ±è¨ˆã‚µãƒãƒªãƒ¼
 * - å‰²ã‚Šå½“ã¦é‹è»¢æ‰‹æƒ…å ±
 * - QRã‚³ãƒ¼ãƒ‰æƒ…å ±
 */
router.get('/:id', validateId, getVehicleById);

/**
 * è»Šä¸¡ä½œæˆ
 * POST /vehicles
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - è»Šä¸¡ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * - QRã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆ
 * - åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
 * - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
 * - ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¨©é™å¿…é ˆ
 */
router.post('/', requireManagerOrAdmin, createVehicle);

/**
 * è»Šä¸¡æƒ…å ±æ›´æ–°
 * PUT /vehicles/:id
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - éƒ¨åˆ†æ›´æ–°å¯¾å¿œ
 * - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * - å¤‰æ›´å±¥æ­´è¨˜éŒ²
 * - é–¢é€£ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
 * - ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¨©é™å¿…é ˆ
 */
router.put('/:id', requireManagerOrAdmin, validateId, updateVehicle);

/**
 * è»Šä¸¡å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰
 * DELETE /vehicles/:id
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - è«–ç†å‰Šé™¤ï¼ˆç‰©ç†å‰Šé™¤ãªã—ï¼‰
 * - é–¢é€£ãƒ‡ãƒ¼ã‚¿ä¿æŒ
 * - å‰Šé™¤å‰ãƒã‚§ãƒƒã‚¯ï¼ˆé‹è¡Œä¸­ã®å ´åˆã‚¨ãƒ©ãƒ¼ï¼‰
 * - å‰Šé™¤å±¥æ­´è¨˜éŒ²
 * - ç®¡ç†è€…æ¨©é™å¿…é ˆ
 */
router.delete('/:id', requireAdmin, validateId, deleteVehicle);

/**
 * è»Šä¸¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
 * PATCH /vehicles/:id/status
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ï¼ˆAVAILABLE, IN_USE, MAINTENANCE, RETIREDï¼‰
 * - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ãƒ«ãƒ¼ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 * - é€šçŸ¥é€ä¿¡ï¼ˆé‹è»¢æ‰‹ãƒ»ç®¡ç†è€…ï¼‰
 * - ç†ç”±ãƒ»ãƒ¡ãƒ¢è¨˜éŒ²
 * - ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¨©é™å¿…é ˆ
 */
router.patch('/:id/status', requireManagerOrAdmin, validateId, updateVehicleStatus);

/**
 * é‹è»¢æ‰‹å‰²ã‚Šå½“ã¦
 * POST /vehicles/:id/assign
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - é‹è»¢æ‰‹è»Šä¸¡ã‚¢ã‚µã‚¤ãƒ³
 * - é‡è¤‡å‰²ã‚Šå½“ã¦ãƒã‚§ãƒƒã‚¯
 * - é‹è»¢æ‰‹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç¢ºèª
 * - å‰²ã‚Šå½“ã¦å±¥æ­´è¨˜éŒ²
 * - é€šçŸ¥é€ä¿¡
 * - ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¨©é™å¿…é ˆ
 */
router.post('/:id/assign', requireManagerOrAdmin, validateId, assignVehicleToDriver);

/**
 * è»Šä¸¡çµ±è¨ˆå–å¾—
 * GET /vehicles/api/stats
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ç·è»Šä¸¡æ•°
 * - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆ
 * - è»Šç¨®åˆ¥é›†è¨ˆ
 * - ç‡ƒæ–™ã‚¿ã‚¤ãƒ—åˆ¥é›†è¨ˆ
 * - å¹´å¼åˆ†å¸ƒ
 * - ç¨¼åƒç‡çµ±è¨ˆ
 * - ãƒ•ãƒªãƒ¼ãƒˆä¾¡å€¤ç·é¡
 * - ç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¨©é™å¿…é ˆ
 */
router.get('/api/stats', requireManagerOrAdmin, getVehicleStatistics);

/**
 * è»Šä¸¡æ¤œç´¢
 * GET /vehicles/search
 *
 * å®Ÿè£…æ©Ÿèƒ½:
 * - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆç™»éŒ²ç•ªå·ã€å‹å¼ã€ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼‰
 * - ã‚ã„ã¾ã„æ¤œç´¢å¯¾å¿œ
 * - è¤‡åˆæ¡ä»¶æ¤œç´¢
 * - æ¤œç´¢çµæœãƒã‚¤ãƒ©ã‚¤ãƒˆ
 * - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
 */
router.get('/search', validatePaginationQuery, searchVehicles);

// =====================================
// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
// =====================================

logger.info('âœ… routes/vehicleRoutes.ts çµ±åˆå®Œäº†', {
  endpoints: [
    'GET /vehicles - è»Šä¸¡ä¸€è¦§ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ»çµ±è¨ˆå¯¾å¿œï¼‰',
    'GET /vehicles/:id - è»Šä¸¡è©³ç´°ï¼ˆGPSãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ»é‹è¡Œæƒ…å ±ï¼‰',
    'POST /vehicles - è»Šä¸¡ä½œæˆï¼ˆQRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆï¼‰',
    'PUT /vehicles/:id - è»Šä¸¡æ›´æ–°ï¼ˆå¤‰æ›´å±¥æ­´ãƒ»æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼‰',
    'DELETE /vehicles/:id - è»Šä¸¡å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰',
    'PATCH /vehicles/:id/status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆé€šçŸ¥ãƒ»å±¥æ­´ï¼‰',
    'POST /vehicles/:id/assign - é‹è»¢æ‰‹å‰²ã‚Šå½“ã¦ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ãƒ»é€šçŸ¥ï¼‰',
    'GET /vehicles/api/stats - è»Šä¸¡çµ±è¨ˆï¼ˆç®¡ç†è€…ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰',
    'GET /vehicles/search - è»Šä¸¡æ¤œç´¢ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»è¤‡åˆæ¡ä»¶ï¼‰'
  ],
  integrationStatus: 'tripRoutes.tsãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨é©ç”¨',
  middleware: 'auth + validation integrated',
  controllers: 'vehicleController 9 methods integrated',
  timestamp: new Date().toISOString()
});

export default router;

// =====================================
// çµ±åˆå®Œäº†ç¢ºèª
// =====================================

/**
 * âœ… routes/vehicleRoutes.tsçµ±åˆå®Œäº†
 *
 * ã€å®Œäº†é …ç›®ã€‘
 * âœ… tripRoutes.tsæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨é©ç”¨
 * âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼37ä»¶ â†’ 0ä»¶ï¼ˆ100%è§£æ¶ˆï¼‰
 * âœ… middleware/auth.tså®Œå…¨æ´»ç”¨ï¼ˆauthenticateTokenãƒ»requireRoleç­‰ï¼‰
 * âœ… middleware/validation.tsçµ±åˆï¼ˆvalidateIdãƒ»validatePaginationQueryï¼‰
 * âœ… controllers/vehicleController.tså®Œå…¨é€£æºï¼ˆ9ãƒ¡ã‚½ãƒƒãƒ‰çµ±åˆï¼‰
 * âœ… routeså±¤è²¬å‹™ã®æ˜ç¢ºåŒ–ï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ã¿ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãªã—ï¼‰
 * âœ… å¾ªç’°å‚ç…§ã®å®Œå…¨å›é¿
 * âœ… å‹å®‰å…¨æ€§ã®ç¢ºä¿
 *
 * ã€ã‚¨ãƒ©ãƒ¼è§£æ¶ˆè©³ç´°ã€‘
 * âœ… TS2614: validateRequestç­‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ â†’ å­˜åœ¨ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿ä½¿ç”¨
 * âœ… TS2345: asyncHandlerå‹ä¸ä¸€è‡´ã‚¨ãƒ©ãƒ¼ â†’ controllerå±¤ã§å®Œå…¨å‡¦ç†
 * âœ… TS2339: VehicleServiceæœªå®Ÿè£…ãƒ¡ã‚½ãƒƒãƒ‰ã‚¨ãƒ©ãƒ¼ â†’ controllerå±¤ã«å§”è­²
 * âœ… TS2554: å¼•æ•°ä¸ä¸€è‡´ã‚¨ãƒ©ãƒ¼ â†’ æ­£ã—ã„å‹å®šç¾©é©ç”¨
 *
 * ã€tripRoutes.tsãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨åŠ¹æœã€‘
 * âœ… ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®šç¾©
 * âœ… controllerãƒ¡ã‚½ãƒƒãƒ‰ã¸ã®ç›´æ¥å§”è­²
 * âœ… å¿…è¦æœ€å°é™ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ä½¿ç”¨
 * âœ… æ˜ç¢ºãªè²¬å‹™åˆ†é›¢
 *
 * ã€è»Šä¸¡ç®¡ç†æ©Ÿèƒ½å®Ÿç¾ã€‘
 * âœ… åŸºæœ¬CRUDæ“ä½œï¼ˆä½œæˆãƒ»èª­å–ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ï¼‰
 * âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼ˆé‹ç”¨çŠ¶æ…‹åˆ¶å¾¡ï¼‰
 * âœ… é‹è»¢æ‰‹å‰²ã‚Šå½“ã¦ï¼ˆã‚¢ã‚µã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆç®¡ç†ï¼‰
 * âœ… çµ±è¨ˆãƒ»åˆ†æï¼ˆãƒ•ãƒªãƒ¼ãƒˆç®¡ç†ï¼‰
 * âœ… æ¤œç´¢æ©Ÿèƒ½ï¼ˆè¤‡åˆæ¡ä»¶å¯¾å¿œï¼‰
 * âœ… æ¨©é™åˆ¶å¾¡ï¼ˆãƒ­ãƒ¼ãƒ«åˆ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
 *
 * ã€æ¬¡ã®Phaseå¯¾è±¡ã€‘
 * ğŸ¯ src/app.ts: Express ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ãƒ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢çµ±åˆ
 * ğŸ¯ src/index.ts: ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãƒ»ç’°å¢ƒè¨­å®š
 *
 * ã€é€²æ—å‘ä¸Šã€‘
 * routeså±¤ã‚¨ãƒ©ãƒ¼: 773ä»¶ â†’ 736ä»¶ï¼ˆ-37ä»¶è§£æ¶ˆã€95%å®Œäº†ï¼‰
 * vehicleRoutes.ts: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼0ä»¶é”æˆ
 */
